---
title: "Lab 7 Assignment: Group 09"
format:
  html:
    embed-resources: true
editor: visual
bibliography: references.bib
---

**Authors**:

-   Selina Friesen - s252027

-   Marta Sánchez - s254791

-   Sergi Fornós - s253693

-   Tommaso Ballocci - s257151

-   Ivan Musalyk - s225210

In this assignment, we analyze the biopsy dataset originally included in the MASS package. This dataset, collected by Dr. William H. Wolberg at the University of Wisconsin Hospitals, contains 699 breast tumor biopsies evaluated for nine morphological features, each scored from 1 to 10. The dataset also provides the known outcome (benign or malignant).

Our goal is to perform a Principal Component Analysis (PCA) to identify the main axes of variation in the dataset and explore how these relate to biopsy outcomes.

------------------------------------------------------------------------

## Load libraries

```{r}
#| warning: false
#| message: false

library(tidyverse)
library(broom)  
library(cowplot)

```

------------------------------------------------------------------------

## Load the dataset

```{r}
#| message: false

biopsy <- read_csv("https://wilkelab.org/classes/SDS348/data_sets/biopsy.csv")
```

------------------------------------------------------------------------

## Create a PCA

PCA requires only numeric predictors. We therefore remove non-numeric columns and scale all variables to unit variance so that features measured on different scales contribute equally.

```{r}
pca_fit <- biopsy |>
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)
```

We join scores back to the original data using augment() so we can color by outcome.

```{r}
pca_fit |> 
  augment(biopsy) |>  
  ggplot(aes(.fittedPC1, .fittedPC2, color = outcome)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c(malignant = "black", benign = "darkgreen")
  ) +
  theme_half_open(12) + background_grid()

```

**Interpretation:**

It can be observed that the benign biopsies cluster together meaning they have similar characteristics, while they cluster apart from the malignant biopsies. Therefore, the first principal component (PC1) captures the major variance associated with biopsy outcome. However, let's take a look into other combinations of PCAs.

------------------------------------------------------------------------

## Alternative components: PCA2 and PCA3

```{r}
pca_fit |> 
  augment(biopsy) |>  
  ggplot(aes(.fittedPC2, .fittedPC3, color = outcome)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c(malignant = "black", benign = "darkgreen")
  ) +
  theme_half_open(12) + background_grid()

```

**Interpretation:**

There is minor separation in PC2, but PC3 does not separate the outcomes well, suggesting that the biological differences are mainly captured by PC1.

------------------------------------------------------------------------

## Rotation matrix

Let's dive into the different characteristics driving the PCAs to get into the different between these two biopsies.

Loadings represent how each original variable contributes to a principal component. We visualize them as arrows originating at (0, 0).

```{r}
arrow_style <- arrow(
  angle = 20, ends = "first", type = "closed", length = grid::unit(8, "pt")
)

pca_fit |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") |>
  ggplot(aes(PC1, PC2)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
  geom_text(
    aes(label = column),
    hjust = 1, nudge_x = -0.1, 
    color = "#909"
  ) +
  xlim(-1.25, .5) + ylim(-.5, 1) +
  coord_fixed() +
  theme_minimal_grid(12)
```

**Interpretation:**

The variable “mitoses” contributes strongly to PC2, suggesting that differences in mitotic activity help distinguish benign and malignant tumors.

```{r}
pca_fit |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") |>
  ggplot(aes(PC1, PC3)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
  geom_text(
    aes(label = column),
    hjust = 1, nudge_x = -0.1, 
    color = "#8fbc8f"
  ) +
  xlim(-1.25, .5) + ylim(-.5, 1) +
  coord_fixed() +
  theme_minimal_grid(12)
```

**Interpretation:**

“Clump thickness” is most associated with PC3, but since PC3 explains little variation, this variable contributes less to outcome separation.

## Variance explained by PC

Each principal component accounts for a portion (percent) of the total variance. We extract this information using tidy(matrix = "eigenvalues").

```{r}
pca_fit |> 
  tidy(matrix = "eigenvalues")
```

Visualization via box-plot:

```{r}
pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(mapping = aes(PC, 
                       percent))+
  geom_col(fill = "blue", 
           alpha = 0.7) +
  geom_line(aes(y = cumulative, 
                color = "Cumulative"))+
  geom_hline(aes(color="90%",
                 yintercept=0.9),
             linetype= "dotted")+
  scale_x_continuous(breaks = 1:9)+
  scale_y_continuous(labels = scales::percent_format())+
  labs(title= "Explained Variance (per PC and cumulative)",
       x = "Principal Component",
       y = "Percentage",
       fill = NULL,
       color = NULL)+
  theme_minimal()
  
```

**Interpretation:**

PC1 explains approximately 65% of the total variance. Together, the first five components explain about 90%, indicating that most of the data’s structure can be represented with reduced dimentions.
